/**
 * @package		AJAX Toggler
 * @copyright	Copyright (C) 2009 - 2012 Blogomunity.com. All rights reserved.
 * @license		Commercial
 */
(function(){this.AjaxToggler=new Class({Implements:[Events,Options],options:{base:null,menu:true,spinner:"plugins/system/ajaxtoggler/spinner.gif",toolbarTasks:["publish","unpublish","featured","archive","checkin","trash","delete","rebuild","duplicate","refresh"]},initialize:function(a){this.setOptions(a);this.parseForm(document.adminForm)},parseForm:function(a){if(!a||!a.task||!a.boxchecked||!a.getElement("table.adminlist")){return}this.form=$(a);this.currentTask=a.task.value;if(typeof this.form["jatoggler"]==="undefined"){this.semafor=(new Element("input",{type:"hidden",name:"jatoggler",value:"0"})).inject(this.form)}window.Joomla.submitform=function(a,b){this.submitForm(a,b)}.bind(this);window.tableOrdering=function(a,b,c){this.tableOrdering(a,b,c)}.bind(this);window.listItemTask=function(a,b){this.listItemTask(a,b)}.bind(this);window.saveorder=function(a,b){this.saveOrder(a,b)}.bind(this)},createWrapper:function(){if(!$("ajaxtogglerWrapper")){this.wrapper=(new Element("div#ajaxtogglerWrapper")).wraps(this.getTable())}},createOverlay:function(){document.body.style.cursor="wait";this.wrapperFx=(new Fx.Tween(this.wrapper,{property:"opacity",duration:100,wait:false})).start(.2);var a=this.getTable();this.overlay=(new Element("div",{id:"ajaxtogglerOverlay",styles:{background:"transparent",position:"absolute",zIndex:"99999",left:"0",top:a.getCoordinates().top+"px",width:"100%",height:a.getSize().y+"px","text-align":"center",overflow:"hidden"}})).inject(document.body);this.spinner=(new Element("img",{src:this.options.base+this.options.spinner,alt:"Loading...",align:"top",styles:{margin:"0 auto"}})).inject(this.overlay).setStyles({marginTop:a.getSize().y/2-25})},removeOverlay:function(){document.body.style.cursor="";this.wrapperFx.cancel().start(1);this.overlay.dispose()},getTable:function(){return this.form.getElement("table.adminlist")},submitForm:function(a,b){if(typeof a!=="undefined"&&a!==""){var c=a;if(c.indexOf(".")!=-1){c=c.split(".")[1];if(this.options.toolbarTasks.contains(c)){this.form.task.value=a;this.loadForm();return false}}this.form.task.value=a;if(typeof this.form.onsubmit=="function"){this.form.onsubmit()}if(typeof this.form.fireEvent=="function"){this.form.fireEvent("submit")}this.form.submit();return}this.loadForm();return false},tableOrdering:function(a,b,c){var d=document.adminForm;d.filter_order.value=a;d.filter_order_Dir.value=b;this.form.task.value=c;this.loadForm();return false},listItemTask:function(a,b){var c=document.adminForm;var d=c[a];if(d){for(var e=0;true;e++){var f=c["cb"+e];if(!f)break;f.checked=false}d.checked=true;c.boxchecked.value=1;this.form.task.value=b;this.loadForm()}return false},saveOrder:function(a,b){if(!b){b="saveorder"}for(var c=0;c<=a;c++){var d=document.adminForm["cb"+c];if(d){if(d.checked==false){d.checked=true}}else{alert("You cannot change the order of items, as an item in the list is `Checked Out`");return}}this.form.task.value=b;this.loadForm();return false},loadForm:function(){this.createWrapper();this.createOverlay();this.semafor.value=1;(new Request.HTML({url:this.form.action,data:this.form,update:$("ajaxtogglerWrapper"),noCache:true,evalScripts:true,onFailure:function(a){this.semafor.value=0;this.form.task.value=this.currentTask;this.removeOverlay()}.bind(this),onSuccess:function(a,b,c,d){this.semafor.value=0;this.form.task.value=this.currentTask;this.form.boxchecked.value="";this.removeOverlay();this.parseForm(document.adminForm);this.checkTips();this.checkScroll();this.checkMessages();this.checkToolbar()}.bind(this)})).send()},checkScroll:function(){if(this.form.getCoordinates().bottom<window.getScrollTop()){window.scroll(0,0)}},checkTips:function(){this.wrapper.getElements(".hasTip").each(function(a){var b=a.get("title");if(b){var c=b.split("::",2);a.store("tip:title",c[0]);a.store("tip:text",c[1])}});var a=new Tips(this.wrapper.getElements(".hasTip"),{maxTitleChars:50,fixed:false})},checkMessages:function(){if($("system-message")){$("system-message").dispose()}if($("jatogglerMessages")){var a=JSON.decode($("jatogglerMessages").innerHTML);if(a){this.messages=(new Element("dl#system-message",{styles:{position:"fixed",top:0,left:0,width:"500px",zIndex:100,margin:"12px 0 0 12px",visibility:"hidden"}})).inject(document.body);(new Element("img",{src:"../media/system/images/modal/closebox.png",onclick:"$('system-message').dispose();",title:"Close messages",styles:{position:"absolute",top:"-11px",right:"-12px",width:"30px",height:"30px",overflow:"hidden",zIndex:101,cursor:"pointer"}})).inject(this.messages);for(var b in a){var c=(new Element("dd",{"class":b+" message"})).inject(this.messages);var d=(new Element("ul",{style:"border:1px solid #999999; padding:10px; margin:0 0 10px; border-radius:10px; -moz-border-radius:10px; -webkit-border-radius:10px; box-shadow: 3px 3px 6px #AAAAAA; -moz-box-shadow: 3px 3px 6px #AAAAAA; -webkit-box-shadow: 3px 3px 6px #AAAAAA; background-position: 4px 3px;"})).inject(c);a[b].each(function(a){(new Element("li",{html:a})).inject(this)}.bind(d))}this.messages.setStyles({top:"-"+this.messages.getSize().y+"px",visibility:"visible"});(new Fx.Tween(this.messages,{property:"top",duration:400,wait:false,transition:Fx.Transitions.Back.easeOut})).start(0)}}},checkToolbar:function(){if($("jatogglerToolbar")&&$("toolbar")){$("toolbar").innerHTML=JSON.decode($("jatogglerToolbar").innerHTML)}}})})()